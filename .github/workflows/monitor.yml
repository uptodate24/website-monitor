name: Mentari Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # tiap 5 menit
  workflow_dispatch:        # bisa run manual

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Restore previous status
      - name: Restore previous status
        uses: actions/cache@v3
        with:
          path: status.txt
          key: website-status

      # 2Ô∏è‚É£ Check Mentari UNPAM
      - name: Check Mentari UNPAM
        id: check
        run: |
          START_TIME=$(date +%s)
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://mentari.unpam.ac.id/" --connect-timeout 10 --max-time 10)
          END_TIME=$(date +%s)
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          PREV_STATUS=$(cat status.txt 2>/dev/null || echo "UNKNOWN")
          echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV
          echo "Status Code: $STATUS_CODE"
          echo "Previous Status: $PREV_STATUS"
          echo "Response Time: ${RESPONSE_TIME}s"

      # 3Ô∏è‚É£ Send UP notification
      - name: Send Discord UP if changed
        if: env.STATUS_CODE == '200' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üü¢ MENTARI UNPAM ONLINE\",
              \"description\": \"Website telah kembali normal dan dapat diakses.\",
              \"color\": 65280,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"üåê URL\", \"value\": \"https://mentari.unpam.ac.id\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"${{ env.STATUS_CODE }}\", \"inline\": true},
                {\"name\": \"‚ö° Response Time\", \"value\": \"${{ env.RESPONSE_TIME }} detik\", \"inline\": true},
                {\"name\": \"üïí Previous Status\", \"value\": \"${{ env.PREV_STATUS }}\", \"inline\": true},
                {\"name\": \"üìÖ Time\", \"value\": \"<t:$(date -d \\\"$TIMESTAMP\\\" +%s):F>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.githubassets.com/favicons/favicon.png\"},
              \"timestamp\": \"$TIMESTAMP\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"
          echo "UP" > status.txt

      # 4Ô∏è‚É£ Send DOWN notification
      - name: Send Discord DOWN if changed
        if: env.STATUS_CODE != '200' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üî¥ MENTARI UNPAM OFFLINE\",
              \"description\": \"Website tidak dapat diakses! Periksa server atau koneksi.\",
              \"color\": 16711680,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"üåê URL\", \"value\": \"https://mentari.unpam.ac.id\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"${{ env.STATUS_CODE }}\", \"inline\": true},
                {\"name\": \"‚ùå Error\", \"value\": \"HTTP ${{ env.STATUS_CODE }} - $(case \\\"${{ env.STATUS_CODE }}\\\" in 404) echo \\\"Not Found\\\";; 500) echo \\\"Server Error\\\";; 502) echo \\\"Bad Gateway\\\";; 503) echo \\\"Service Unavailable\\\";; 504) echo \\\"Gateway Timeout\\\";; *) echo \\\"Connection Failed\\\";; esac)\", \"inline\": true},
                {\"name\": \"üïí Previous Status\", \"value\": \"${{ env.PREV_STATUS }}\", \"inline\": true},
                {\"name\": \"üìÖ Time\", \"value\": \"<t:$(date -d \\\"$TIMESTAMP\\\" +%s):F>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.githubassets.com/favicons/favicon.png\"},
              \"timestamp\": \"$TIMESTAMP\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"
          echo "DOWN" > status.txt

      # 5Ô∏è‚É£ Status unchanged
      - name: Status unchanged
        if: (env.STATUS_CODE == '200' && env.PREV_STATUS == 'UP') || (env.STATUS_CODE != '200' && env.PREV_STATUS == 'DOWN')
        run: echo "‚úÖ Status unchanged - No notification needed"

      # 6Ô∏è‚É£ Save status to cache
      - name: Save status to cache
        uses: actions/cache@v3
        with:
          path: status.txt
          key: website-status
