name: Mentari Monitor

on:
  schedule:
    - cron: '*/3 * * * *'   # tiap 3 menit
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      # ðŸ”¹ 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # ðŸ”¹ 2. REAL-TIME CHECK YANG BENER 
      - name: Check Mentari UNPAM
        id: check
        run: |
          URL="https://mentari.unpam.ac.id/"
          
          # Baca status sebelumnya
          if [ -f "status.txt" ]; then
            PREV_STATUS=$(cat status.txt)
          else
            PREV_STATUS="UNKNOWN"
          fi

          echo "Previous Status: $PREV_STATUS"

          # ðŸš€ TECHNOLOGY MUTAKHIR - BEDAIN BENER DOWN vs SLOW
          echo "ðŸ” Advanced website checking..."
          ATTEMPT=1
          MAX_ATTEMPTS=2
          SUCCESS=false
          FINAL_STATUS="DOWN"
          FINAL_RESPONSE_TIME=0
          FINAL_STATUS_CODE="000"

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = false ]; do
            echo "Attempt $ATTEMPT..."
            START_TIME=$(date +%s)
            
            # Method 1: Cek dengan curl detail
            RESPONSE=$(timeout 15s curl -v -s -o /dev/null -w "%{http_code} %{time_total}" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              --connect-timeout 12 \
              --max-time 15 \
              "$URL" 2>&1)
            
            CURL_EXIT=$?
            END_TIME=$(date +%s)
            RESPONSE_TIME=$((END_TIME - START_TIME))
            
            # Extract status code dari response verbose
            HTTP_STATUS=$(echo "$RESPONSE" | grep -oE 'HTTP/[0-9.]+ [0-9]+' | tail -1 | awk '{print $2}')
            SIMPLE_STATUS=$(echo "$RESPONSE" | awk '{print $1}')
            
            # Prioritize HTTP status dari header
            if [ -n "$HTTP_STATUS" ] && [ "$HTTP_STATUS" != "000" ]; then
              STATUS_CODE="$HTTP_STATUS"
            else
              STATUS_CODE="$SIMPLE_STATUS"
            fi
            
            echo "Attempt $ATTEMPT - Status: $STATUS_CODE, Time: ${RESPONSE_TIME}s, Exit: $CURL_EXIT"
            
            # ðŸŽ¯ CRITICAL FIX: KALAU DAPET 200, LANGSUNG UP
            if [ "$STATUS_CODE" = "200" ]; then
              SUCCESS=true
              FINAL_STATUS_CODE="200"
              FINAL_RESPONSE_TIME=$RESPONSE_TIME
              
              # Tentukan level speed
              if [ "$RESPONSE_TIME" -gt 15 ]; then
                FINAL_STATUS="VERY_SLOW"
                echo "ðŸŸ¡ Website UP tapi VERY SLOW (${RESPONSE_TIME}s)"
              elif [ "$RESPONSE_TIME" -gt 8 ]; then
                FINAL_STATUS="SLOW"
                echo "ðŸŸ¡ Website UP tapi SLOW (${RESPONSE_TIME}s)"
              else
                FINAL_STATUS="UP"
                echo "ðŸŸ¢ Website UP (${RESPONSE_TIME}s)"
              fi
              break
            fi
            
            # ðŸŽ¯ CRITICAL FIX 2: KALAU TIMEOUT/GAGAL, CEK ULANG DENGAN METHOD BERBEDA
            if [ $CURL_EXIT -ne 0 ] || [ "$STATUS_CODE" = "000" ] || [ "$STATUS_CODE" = "TIMEOUT" ]; then
              echo "âŒ Attempt $ATTEMPT failed, trying alternative method..."
              
              # Method 2: Cek hanya HEAD request (lebih cepat)
              START_TIME2=$(date +%s)
              HEAD_RESPONSE=$(timeout 8s curl -I -s -o /dev/null -w "%{http_code}" \
                -H "User-Agent: Monitor-Bot/1.0" \
                --connect-timeout 6 \
                --max-time 8 \
                "$URL" 2>/dev/null || echo "000")
              END_TIME2=$(date +%s)
              HEAD_TIME=$((END_TIME2 - START_TIME2))
              
              echo "HEAD Check - Status: $HEAD_RESPONSE, Time: ${HEAD_TIME}s"
              
              if [ "$HEAD_RESPONSE" = "200" ]; then
                SUCCESS=true
                FINAL_STATUS_CODE="200"
                FINAL_RESPONSE_TIME=$HEAD_TIME
                FINAL_STATUS="UP"
                echo "ðŸŸ¢ Website UP via HEAD check (${HEAD_TIME}s)"
                break
              fi
              
              # Method 3: Final attempt - simple connectivity test
              echo "ðŸ”Ž Final connectivity test..."
              if ping -c 2 -W 5 "mentari.unpam.ac.id" 2>/dev/null | grep -q "64 bytes"; then
                echo "ðŸŒ Server is reachable via ping but HTTP failed"
                FINAL_STATUS="DOWN"  # Server up tapi service down
              else
                echo "ðŸ”´ Server completely unreachable"
                FINAL_STATUS="DOWN"
              fi
            fi
            
            FINAL_STATUS_CODE="$STATUS_CODE"
            FINAL_RESPONSE_TIME=$RESPONSE_TIME
            ATTEMPT=$((ATTEMPT + 1))
            sleep 2
          done

          # ðŸŽ¯ FINAL DECISION: KALAU GA DAPET 200, PASTI DOWN
          if [ "$SUCCESS" = false ]; then
            FINAL_STATUS="DOWN"
            echo "ðŸ”´ FINAL VERDICT: WEBSITE DOWN - No successful HTTP 200 response"
          fi

          echo "STATUS_CODE=$FINAL_STATUS_CODE" >> $GITHUB_ENV
          echo "CURRENT_STATUS=$FINAL_STATUS" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$FINAL_RESPONSE_TIME" >> $GITHUB_ENV

          echo "ðŸ“Š FINAL: $PREV_STATUS â†’ $FINAL_STATUS (Code: $FINAL_STATUS_CODE, Time: ${FINAL_RESPONSE_TIME}s)"

      # ðŸ”¹ 3. Notif UP - ESTHETIC âœ…
      - name: Send Discord UP
        if: env.CURRENT_STATUS == 'UP' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"âœ… MENTARI UNPAM ONLINE\",
              \"description\": \"Website dapat diakses dengan **respon normal**.\",
              \"color\": 5763719,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"ðŸ“Š Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"âš¡ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"ðŸŸ¢ Status\", \"value\": \"**OPERATIONAL**\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"ðŸŒ Monitor\", \"value\": \"GitHub Actions\", \"inline\": true}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "UP" > status.txt
          echo "âœ… UP notification sent"

      # ðŸ”¹ 4. Notif SLOW - ðŸŸ¡
      - name: Send Discord SLOW
        if: (env.CURRENT_STATUS == 'SLOW' || env.CURRENT_STATUS == 'VERY_SLOW') && env.PREV_STATUS != 'SLOW' && env.PREV_STATUS != 'VERY_SLOW'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          if [ "${{ env.CURRENT_STATUS }}" = "VERY_SLOW" ]; then
            TITLE="ðŸŒ MENTARI UNPAM - SANGAT LAMBAT"
            COLOR=16753920
            STATUS_TEXT="**HIGH LATENCY**"
            DESC="Website dapat diakses namun **sangat lambat** (>15s)"
            EMOJI="ðŸŒ"
          else
            TITLE="ðŸŸ¡ MENTARI UNPAM - LAMBAT"
            COLOR=16776960
            STATUS_TEXT="**SLOW**"
            DESC="Website dapat diakses namun **lambat** (>8s)"
            EMOJI="ðŸŸ¡"
          fi
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"${TITLE}\",
              \"description\": \"${DESC}\",
              \"color\": ${COLOR},
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/4206/4206274.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"ðŸ“Š Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"â±ï¸ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"${EMOJI} Status\", \"value\": \"${STATUS_TEXT}\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"ðŸ’¡ Info\", \"value\": \"Server mungkin sedang sibuk\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "SLOW" > status.txt
          echo "ðŸŸ¡ SLOW notification sent"

      # ðŸ”¹ 5. Notif DOWN - ðŸ”´
      - name: Send Discord DOWN
        if: env.CURRENT_STATUS == 'DOWN' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"ðŸ”´ MENTARI UNPAM - OFFLINE\",
              \"description\": \"Website **benar-benar tidak dapat diakses**.\n\\`\\`\\`HTTP Status: ${{ env.STATUS_CODE }} | Response: ${{ env.RESPONSE_TIME }}s\\`\\`\\`\",
              \"color\": 15548997,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"ðŸ“Š Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"â±ï¸ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"ðŸ”´ Status\", \"value\": \"**OFFLINE**\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"âœ… Verified\", \"value\": \"3-step verification\", \"inline\": true}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "DOWN" > status.txt
          echo "ðŸ”´ DOWN notification sent"

      # ðŸ”¹ 6. Status unchanged
      - name: Status unchanged
        if: env.CURRENT_STATUS == env.PREV_STATUS
        run: |
          echo "âœ… Status unchanged: ${{ env.CURRENT_STATUS }}"
          echo "${{ env.CURRENT_STATUS }}" > status.txt

      # ðŸ”¹ 7. Commit status
      - name: Commit status changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add status.txt
          git diff --staged --quiet || git commit -m "Status: $(cat status.txt) [$(date +'%H:%M')]"
          git push
