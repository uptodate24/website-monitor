name: Mentari Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # tiap 5 menit
  workflow_dispatch:        # bisa run manual

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Restore previous status dari cache
      - name: Restore previous status
        uses: actions/cache@v3
        with:
          path: status.txt
          key: website-status

      # 2Ô∏è‚É£ Cek status website
      - name: Check Mentari UNPAM
        id: check
        run: |
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://mentari.unpam.ac.id/" --connect-timeout 10 --max-time 10)
          PREV_STATUS=$(cat status.txt 2>/dev/null || echo "UNKNOWN")
          echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "Status Code: $STATUS_CODE"
          echo "Previous Status: $PREV_STATUS"

      # 3Ô∏è‚É£ Kirim embed Discord jika status berubah
      - name: Send Discord Embed Notification if status changed
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [ "$STATUS_CODE" -eq 200 ] && [ "$PREV_STATUS" != "UP" ]; then
curl -X POST -H "Content-Type: application/json" -d @- "${{ secrets.DISCORD_WEBHOOK }}" <<EOF
{
  "embeds": [{
    "title": "üü¢ Mentari UNPAM BACK UP",
    "description": "Website sudah kembali online.",
    "color": 3066993,
    "fields": [
      {"name": "URL", "value": "https://mentari.unpam.ac.id/", "inline": true},
      {"name": "Status Code", "value": "$STATUS_CODE", "inline": true},
      {"name": "Time (UTC)", "value": "$TIMESTAMP", "inline": false}
    ]
  }]
}
EOF
            echo "UP" > status.txt

          elif [ "$STATUS_CODE" -ne 200 ] && [ "$PREV_STATUS" != "DOWN" ]; then
curl -X POST -H "Content-Type: application/json" -d @- "${{ secrets.DISCORD_WEBHOOK }}" <<EOF
{
  "embeds": [{
    "title": "üî¥ Mentari UNPAM DOWN",
    "description": "Website sedang tidak dapat diakses!",
    "color": 15158332,
    "fields": [
      {"name": "URL", "value": "https://mentari.unpam.ac.id/", "inline": true},
      {"name": "Status Code", "value": "$STATUS_CODE", "inline": true},
      {"name": "Time (UTC)", "value": "$TIMESTAMP", "inline": false}
    ]
  }]
}
EOF
            echo "DOWN" > status.txt

          else
            echo "‚úÖ Status unchanged - No notification needed"

      # 4Ô∏è‚É£ Simpan status.txt ke cache
      - name: Save status to cache
        uses: actions/cache@v3
        with:
          path: status.txt
          key: website-status
