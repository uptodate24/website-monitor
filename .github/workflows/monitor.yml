name: Mentari Monitor

on:
  schedule:
    - cron: '*/3 * * * *'   # tiap 3 menit
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      # 🔹 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # 🔹 2. REAL-TIME CHECK dari multiple user agents
      - name: Check Mentari UNPAM
        id: check
        run: |
          URL="https://mentari.unpam.ac.id/"
          
          # Baca status sebelumnya
          if [ -f "status.txt" ]; then
            PREV_STATUS=$(cat status.txt)
          else
            PREV_STATUS="UNKNOWN"
          fi
          echo "Previous Status: $PREV_STATUS"

          # 🔄 TRY 1: Normal check
          echo "🔍 Attempt 1: Normal check..."
          START_TIME=$(date +%s)
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            -H "Accept-Language: id,en;q=0.7" \
            --connect-timeout 5 \
            --max-time 8 \
            "$URL" 2>/dev/null || echo "000")
          END_TIME=$(date +%s)
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          echo "Attempt 1 - Status: $STATUS_CODE, Time: ${RESPONSE_TIME}s"

          # Jika attempt 1 gagal, coba dengan approach berbeda
          if [ "$STATUS_CODE" != "200" ]; then
            echo "🔄 Attempt 1 failed, trying different approach..."
            
            # 🔄 TRY 2: Simulate mobile browser
            START_TIME=$(date +%s)
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: Mozilla/5.0 (Linux; Android 10; SM-A205F) AppleWebKit/537.36" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
              --connect-timeout 8 \
              --max-time 10 \
              "$URL" 2>/dev/null || echo "000")
            END_TIME=$(date +%s)
            RESPONSE_TIME=$((END_TIME - START_TIME))
            
            echo "Attempt 2 - Status: $STATUS_CODE, Time: ${RESPONSE_TIME}s"
          fi

          # 🔄 TRY 3: Final attempt dengan timeout lebih longgar
          if [ "$STATUS_CODE" != "200" ]; then
            echo "🔄 Attempt 2 failed, final attempt..."
            
            # Cek hanya header saja (lebih cepat)
            START_TIME=$(date +%s)
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: Mozilla/5.0 (compatible; Monitor-Bot/1.0)" \
              -I \
              --connect-timeout 10 \
              --max-time 12 \
              "$URL" 2>/dev/null || echo "000")
            END_TIME=$(date +%s)
            RESPONSE_TIME=$((END_TIME - START_TIME))
            
            echo "Attempt 3 - Status: $STATUS_CODE, Time: ${RESPONSE_TIME}s"
          fi

          # Tentukan status akhir
          if [ "$STATUS_CODE" = "200" ]; then
            if [ "$RESPONSE_TIME" -gt 8 ]; then
              CURRENT_STATUS="SLOW"
              echo "🟡 Website accessible but SLOW (${RESPONSE_TIME}s)"
            else
              CURRENT_STATUS="UP" 
              echo "🟢 Website UP (${RESPONSE_TIME}s)"
            fi
          else
            # VERIFIKASI FINAL: Cek dengan curl simple
            echo "🔎 Final verification..."
            if curl -s --head --connect-timeout 5 --max-time 7 "$URL" >/dev/null 2>&1; then
              CURRENT_STATUS="UP"
              echo "🟢 VERIFIED: Website is actually UP!"
            else
              CURRENT_STATUS="DOWN"
              echo "🔴 CONFIRMED: Website is DOWN"
            fi
          fi

          # Simpan ke environment variables
          echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
          echo "CURRENT_STATUS=$CURRENT_STATUS" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV

          echo "📊 FINAL: Previous=$PREV_STATUS, Current=$CURRENT_STATUS, Code=$STATUS_CODE, Time=${RESPONSE_TIME}s"

      # 🔹 3. Notif UP
      - name: Send Discord UP
        if: env.CURRENT_STATUS == 'UP' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          echo "🟢 Status changed to UP - Sending notification..."

          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"🟢 MENTARI UNPAM ONLINE\",
              \"description\": \"Website Universitas Pamulang dapat diakses normal.\",
              \"color\": 3066993,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"🔗 URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"📊 Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"⚡ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"🌍 Server Location\", \"value\": \"GitHub Actions (US)\", \"inline\": true},
                {\"name\": \"🔄 Previous Status\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"🕐 Time\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Real-time Monitor • GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "UP" > status.txt
          echo "✅ UP notification sent"

      # 🔹 4. Notif DOWN (HANYA jika benar-benar down)
      - name: Send Discord DOWN
        if: env.CURRENT_STATUS == 'DOWN' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          echo "🔴 Status changed to DOWN - Sending notification..."

          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"🔴 MENTARI UNPAM OFFLINE\",
              \"description\": \"Website tidak dapat diakses dari server monitoring.\",
              \"color\": 15158332,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"🔗 URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"📊 Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"🌍 Server Location\", \"value\": \"GitHub Actions (US)\", \"inline\": true},
                {\"name\": \"⚠️ Note\", \"value\": \"Ini mungkin issue geographic blocking\", \"inline\": false},
                {\"name\": \"🔄 Previous Status\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"🕐 Time\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Real-time Monitor • GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "DOWN" > status.txt
          echo "🔴 DOWN notification sent"

      # 🔹 5. Status unchanged
      - name: Status unchanged
        if: env.CURRENT_STATUS == env.PREV_STATUS
        run: |
          echo "✅ Status unchanged: ${{ env.CURRENT_STATUS }} - No notification"
          echo "${{ env.CURRENT_STATUS }}" > status.txt

      # 🔹 6. Commit status
      - name: Commit status changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add status.txt
          git diff --staged --quiet || git commit -m "Update: $(cat status.txt) [$(date +'%H:%M')]"
          git push
