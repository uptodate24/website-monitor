name: Mentari Monitor

on:
  schedule:
    - cron: '*/3 * * * *'   # tiap 3 menit
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      # 🔹 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # 🔹 2. REAL-TIME CHECK YANG OPTIMAL
      - name: Check Mentari UNPAM
        id: check
        run: |
          URL="https://mentari.unpam.ac.id/"
          
          # Baca status sebelumnya
          if [ -f "status.txt" ]; then
            PREV_STATUS=$(cat status.txt)
          else
            PREV_STATUS="UNKNOWN"
          fi

          echo "Previous Status: $PREV_STATUS"

          # 🚀 OPTIMAL CHECK - TIMEOUT LEBIH SINGKAT
          echo "🔍 Smart website checking..."
          FINAL_STATUS="DOWN"
          FINAL_STATUS_CODE="000"
          FINAL_RESPONSE_TIME=0

          # Method 1: Quick HEAD request dulu
          echo "📡 Attempt 1: HEAD request (timeout 8s)..."
          START_TIME=$(date +%s)
          HEAD_RESPONSE=$(curl -I -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --connect-timeout 5 \
            --max-time 8 \
            "$URL" 2>/dev/null || echo "000")
          END_TIME=$(date +%s)
          HEAD_TIME=$((END_TIME - START_TIME))
          
          echo "HEAD Check - Status: $HEAD_RESPONSE, Time: ${HEAD_TIME}s"

          # Jika HEAD berhasil, lanjut cek full
          if [ "$HEAD_RESPONSE" = "200" ]; then
            echo "🟢 HEAD success, checking full content..."
            START_TIME=$(date +%s)
            FULL_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              --connect-timeout 8 \
              --max-time 12 \
              "$URL" 2>/dev/null || echo "000")
            END_TIME=$(date +%s)
            FULL_TIME=$((END_TIME - START_TIME))
            
            echo "Full Check - Status: $FULL_RESPONSE, Time: ${FULL_TIME}s"
            
            if [ "$FULL_RESPONSE" = "200" ]; then
              FINAL_STATUS_CODE="200"
              FINAL_RESPONSE_TIME=$FULL_TIME
              
              if [ "$FULL_TIME" -gt 10 ]; then
                FINAL_STATUS="SLOW"
                echo "🟡 Website UP but SLOW (${FULL_TIME}s)"
              else
                FINAL_STATUS="UP"
                echo "🟢 Website UP (${FULL_TIME}s)"
              fi
            else
              FINAL_STATUS="DOWN"
              FINAL_STATUS_CODE="$FULL_RESPONSE"
              echo "🔴 Full content check failed"
            fi
          else
            # HEAD gagal, coba method alternatif
            echo "🔄 HEAD failed, trying alternative..."
            
            # Method 2: Simple GET dengan timeout sangat singkat
            START_TIME=$(date +%s)
            QUICK_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: Monitor-Bot/1.0" \
              --connect-timeout 3 \
              --max-time 6 \
              "$URL" 2>/dev/null || echo "000")
            END_TIME=$(date +%s)
            QUICK_TIME=$((END_TIME - START_TIME))
            
            echo "Quick Check - Status: $QUICK_RESPONSE, Time: ${QUICK_TIME}s"
            
            if [ "$QUICK_RESPONSE" = "200" ]; then
              FINAL_STATUS_CODE="200"
              FINAL_RESPONSE_TIME=$QUICK_TIME
              FINAL_STATUS="UP"
              echo "🟢 Website UP via quick check (${QUICK_TIME}s)"
            else
              FINAL_STATUS="DOWN"
              FINAL_STATUS_CODE="$QUICK_RESPONSE"
              echo "🔴 All checks failed - Website DOWN"
            fi
          fi

          # Simpan ke environment variables
          echo "STATUS_CODE=$FINAL_STATUS_CODE" >> $GITHUB_ENV
          echo "CURRENT_STATUS=$FINAL_STATUS" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$FINAL_RESPONSE_TIME" >> $GITHUB_ENV

          echo "📊 FINAL: $PREV_STATUS → $FINAL_STATUS (Code: $FINAL_STATUS_CODE, Time: ${FINAL_RESPONSE_TIME}s)"

      # 🔹 3. Notif UP - ESTHETIC ✅
      - name: Send Discord UP
        if: env.CURRENT_STATUS == 'UP' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"🌐 Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"✅ MENTARI UNPAM ONLINE\",
              \"description\": \"Website dapat diakses dengan **respon normal**.\",
              \"color\": 5763719,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"🔗 URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"📊 Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"⚡ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"🟢 Status\", \"value\": \"**OPERATIONAL**\", \"inline\": true},
                {\"name\": \"🔄 Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true}
              ],
              \"footer\": {\"text\": \"Mentari Monitor • $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "UP" > status.txt
          echo "✅ UP notification sent"

      # 🔹 4. Notif SLOW - 🟡
      - name: Send Discord SLOW
        if: env.CURRENT_STATUS == 'SLOW' && env.PREV_STATUS != 'SLOW'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"🌐 Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"🟡 MENTARI UNPAM - LAMBAT\",
              \"description\": \"Website dapat diakses namun **lambat** (>10s).\",
              \"color\": 16776960,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/4206/4206274.png\"},
              \"fields\": [
                {\"name\": \"🔗 URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"📊 Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"⏱️ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"🟡 Status\", \"value\": \"**SLOW**\", \"inline\": true},
                {\"name\": \"🔄 Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"💡 Info\", \"value\": \"Server mungkin sedang sibuk\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor • $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "SLOW" > status.txt
          echo "🟡 SLOW notification sent"

      # 🔹 5. Notif DOWN - 🔴
      - name: Send Discord DOWN
        if: env.CURRENT_STATUS == 'DOWN' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Determine error message
          case "${{ env.STATUS_CODE }}" in
            000) ERROR_MSG="Connection Timeout" ;;
            404) ERROR_MSG="Not Found" ;;
            500) ERROR_MSG="Server Error" ;;
            502|503|504) ERROR_MSG="Service Unavailable" ;;
            *) ERROR_MSG="HTTP ${{ env.STATUS_CODE }}" ;;
          esac
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"🌐 Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"🔴 MENTARI UNPAM - OFFLINE\",
              \"description\": \"Website **tidak dapat diakses**.\n**Error:** $ERROR_MSG\",
              \"color\": 15548997,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"🔗 URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"📊 Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"⏱️ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"🔴 Status\", \"value\": \"**OFFLINE**\", \"inline\": true},
                {\"name\": \"🔄 Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"✅ Check Method\", \"value\": \"2-step verification\", \"inline\": true}
              ],
              \"footer\": {\"text\": \"Mentari Monitor • $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "DOWN" > status.txt
          echo "🔴 DOWN notification sent"

      # 🔹 6. Status unchanged
      - name: Status unchanged
        if: env.CURRENT_STATUS == env.PREV_STATUS
        run: |
          echo "✅ Status unchanged: ${{ env.CURRENT_STATUS }}"
          echo "${{ env.CURRENT_STATUS }}" > status.txt

      # 🔹 7. Commit status
      - name: Commit status changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add status.txt
          git diff --staged --quiet || git commit -m "Status: $(cat status.txt) [$(date +'%H:%M')]"
          git push
