name: Mentari Monitor

on:
  schedule:
    - cron: '*/5 * * * *'   # tiap 5 menit
  workflow_dispatch:         # bisa run manual

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      # üîπ 1. Restore status.txt dari cache
      - name: Restore status cache
        uses: actions/cache@v3
        with:
          path: status.txt
          key: website-status-${{ github.ref }}
          restore-keys: |
            website-status-${{ github.ref }}

      # üîπ 2. Cek status website (DIPERBAIKI)
      - name: Check Mentari UNPAM
        id: check
        run: |
          # Inisialisasi status sebelumnya
          if [ -f "status.txt" ]; then
            PREV_STATUS=$(cat status.txt)
          else
            PREV_STATUS="UNKNOWN"
          fi
          
          echo "Previous Status: $PREV_STATUS"
          
          # Cek website dengan timeout yang lebih baik
          START_TIME=$(date +%s)
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://mentari.unpam.ac.id/" --connect-timeout 15 --max-time 20 || echo "000")
          END_TIME=$(date +%s)
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          # Jika curl gagal (timeout/connection failed)
          if [ "$STATUS_CODE" = "000" ]; then
            STATUS_CODE="000"
            echo "Website is DOWN - Connection failed or timeout"
          fi
          
          echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV
          
          echo "Status Code: $STATUS_CODE"
          echo "Response Time: ${RESPONSE_TIME}s"

      # üîπ 3. Kirim notif kalau UP lagi (DIPERBAIKI)
      - name: Send Discord UP if changed
        if: env.STATUS_CODE == '200' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üü¢ MENTARI UNPAM ONLINE\",
              \"description\": \"Website Universitas Pamulang kembali dapat diakses.\",
              \"color\": 3066993,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"üîó URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"‚ö° Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"üîÑ Status Sebelumnya\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"üïê Waktu\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"
          
          echo "UP" > status.txt
          echo "‚úÖ UP notification sent"

      # üîπ 4. Kirim notif kalau DOWN (DIPERBAIKI)
      - name: Send Discord DOWN if changed
        if: env.STATUS_CODE != '200' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          
          case "${{ env.STATUS_CODE }}" in
            000) ERROR_MSG="Connection Failed / Timeout" ;;
            404) ERROR_MSG="Halaman Tidak Ditemukan" ;;
            500) ERROR_MSG="Server Error" ;;
            502) ERROR_MSG="Bad Gateway" ;;
            503) ERROR_MSG="Service Unavailable" ;;
            504) ERROR_MSG="Gateway Timeout" ;;
            *) ERROR_MSG="Koneksi Gagal / Error ${{ env.STATUS_CODE }}" ;;
          esac
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üî¥ MENTARI UNPAM OFFLINE\",
              \"description\": \"Website Universitas Pamulang tidak dapat diakses!\",
              \"color\": 15158332,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"üîó URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"‚ùå Error\", \"value\": \"\`${ERROR_MSG}\`\", \"inline\": true},
                {\"name\": \"‚ö° Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"üîÑ Status Sebelumnya\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"üïê Waktu\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"
          
          echo "DOWN" > status.txt
          echo "üî¥ DOWN notification sent"

      # üîπ 5. Kalau status sama ‚Üí no notif
      - name: Status unchanged
        if: (env.STATUS_CODE == '200' && env.PREV_STATUS == 'UP') || (env.STATUS_CODE != '200' && env.PREV_STATUS == 'DOWN')
        run: |
          echo "‚úÖ Status unchanged - No notification needed"
          echo "Current: ${{ env.STATUS_CODE }}, Previous: ${{ env.PREV_STATUS }}"

      # üîπ 6. Simpan status.txt ke cache (DIPERBAIKI)
      - name: Save status cache
        uses: actions/cache@v3
        with:
          path: status.txt
          key: website-status-${{ github.ref }}-${{ hashFiles('status.txt') }}
          restore-keys: |
            website-status-${{ github.ref }}-
