name: Mentari Monitor

on:
  schedule:
    - cron: '*/5 * * * *'   # setiap 5 menit
  workflow_dispatch:         # bisa dijalankan manual

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      # üîπ 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # üîπ 2. Cek status website (FIXED CURL COMMAND)
      - name: Check Mentari UNPAM
        id: check
        run: |
          URL="https://mentari.unpam.ac.id/"
          ATTEMPTS=3
          SUCCESS=false
          MAX_TIME=10
          
          # Baca status sebelumnya
          if [ -f "status.txt" ]; then
            PREV_STATUS=$(cat status.txt)
          else
            PREV_STATUS="UNKNOWN"
          fi

          echo "Previous Status: $PREV_STATUS"

          # Coba 3x request dengan curl yang diperbaiki
          for i in $(seq 1 $ATTEMPTS); do
            echo "üîç Attempt $i..."
            START_TIME=$(date +%s)
            
            # FIX: Clean curl command dengan output yang lebih simple
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" --connect-timeout 10 --max-time 15 2>/dev/null)
            EXIT_CODE=$?
            
            END_TIME=$(date +%s)
            RESPONSE_TIME=$((END_TIME - START_TIME))
            
            # Jika curl gagal, set status code ke 000
            if [ $EXIT_CODE -ne 0 ] || [ -z "$RESPONSE" ]; then
              STATUS_CODE="000"
            else
              # Hanya ambil 3 digit pertama untuk pastikan format benar
              STATUS_CODE=$(echo "$RESPONSE" | head -c 3)
            fi
            
            echo "Response time: ${RESPONSE_TIME}s, Status: $STATUS_CODE, Exit Code: $EXIT_CODE"
            
            if [ "$STATUS_CODE" = "200" ]; then
              SUCCESS=true
              break
            fi
            
            if [ $i -lt $ATTEMPTS ]; then
              echo "‚ùå Attempt $i failed, retrying..."
              sleep 2
            fi
          done

          # Tentukan status berdasarkan hasil
          if [ "$SUCCESS" = true ]; then
            if [ "$RESPONSE_TIME" -gt "$MAX_TIME" ]; then
              CURRENT_STATUS="SLOW"
              echo "üü° Website UP but SLOW (${RESPONSE_TIME}s)"
            else
              CURRENT_STATUS="UP"
              echo "üü¢ Website UP (${RESPONSE_TIME}s)"
            fi
          else
            CURRENT_STATUS="DOWN"
            echo "üî¥ Website DOWN - Final Status Code: $STATUS_CODE"
          fi

          # Simpan ke environment variables
          echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
          echo "CURRENT_STATUS=$CURRENT_STATUS" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV

          echo "üìä FINAL RESULT: Previous=$PREV_STATUS, Current=$CURRENT_STATUS, Code=$STATUS_CODE, Time=${RESPONSE_TIME}s"

      # üîπ 3. Debug Information
      - name: Debug Information
        run: |
          echo "=== üêõ DEBUG INFO ==="
          echo "STATUS_CODE: '${{ env.STATUS_CODE }}'"
          echo "CURRENT_STATUS: '${{ env.CURRENT_STATUS }}'"
          echo "PREV_STATUS: '${{ env.PREV_STATUS }}'"
          echo "RESPONSE_TIME: '${{ env.RESPONSE_TIME }}'"
          echo "UP Condition: ${{ env.CURRENT_STATUS == 'UP' && env.PREV_STATUS != 'UP' }}"
          echo "DOWN Condition: ${{ env.CURRENT_STATUS == 'DOWN' && env.PREV_STATUS != 'DOWN' }}"
          echo "SLOW Condition: ${{ env.CURRENT_STATUS == 'SLOW' && env.PREV_STATUS != 'SLOW' }}"

      # üîπ 4. Notif UP
      - name: Send Discord UP
        if: env.CURRENT_STATUS == 'UP' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          echo "üü¢ Mengirim notifikasi UP..."

          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üü¢ MENTARI UNPAM ONLINE\",
              \"description\": \"Website Universitas Pamulang kembali normal dan dapat diakses dengan cepat.\",
              \"color\": 3066993,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"üîó URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"‚ö° Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"üîÑ Status Sebelumnya\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"üïê Waktu\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "UP" > status.txt
          echo "‚úÖ UP notification sent"

      # üîπ 5. Notif SLOW
      - name: Send Discord SLOW
        if: env.CURRENT_STATUS == 'SLOW' && env.PREV_STATUS != 'SLOW'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          echo "üü† Mengirim notifikasi SLOW..."

          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üü† MENTARI UNPAM LAMBAT\",
              \"description\": \"Website masih dapat diakses namun memiliki waktu respon tinggi (>10s). Kemungkinan server sedang sibuk.\",
              \"color\": 16753920,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/2099/2099058.png\"},
              \"fields\": [
                {\"name\": \"üîó URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"‚ö° Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"üîÑ Status Sebelumnya\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"üïê Waktu\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "SLOW" > status.txt
          echo "üü† SLOW notification sent"

      # üîπ 6. Notif DOWN
      - name: Send Discord DOWN
        if: env.CURRENT_STATUS == 'DOWN' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DISCORD_TIMESTAMP=$(date -u +%s)
          echo "üî¥ Mengirim notifikasi DOWN..."

          case "${{ env.STATUS_CODE }}" in
            000) ERROR_MSG="Connection Failed / Timeout" ;;
            404) ERROR_MSG="Not Found (404)" ;;
            500) ERROR_MSG="Internal Server Error" ;;
            502) ERROR_MSG="Bad Gateway" ;;
            503) ERROR_MSG="Service Unavailable" ;;
            504) ERROR_MSG="Gateway Timeout" ;;
            *) ERROR_MSG="Error Code ${{ env.STATUS_CODE }}" ;;
          esac

          curl -X POST -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"üî¥ MENTARI UNPAM OFFLINE\",
              \"description\": \"Website Universitas Pamulang tidak dapat diakses setelah 3 percobaan.\",
              \"color\": 15158332,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"üîó URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"üìä Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"‚ùå Error\", \"value\": \"\`${ERROR_MSG}\`\", \"inline\": true},
                {\"name\": \"üîÑ Status Sebelumnya\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"üïê Waktu\", \"value\": \"<t:${DISCORD_TIMESTAMP}:R>\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor ‚Ä¢ GitHub Actions\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "DOWN" > status.txt
          echo "üî¥ DOWN notification sent"

      # üîπ 7. Jika status sama, tidak kirim notif
      - name: Status unchanged
        if: env.CURRENT_STATUS == env.PREV_STATUS
        run: |
          echo "‚úÖ Status unchanged: ${{ env.CURRENT_STATUS }} - No notification needed"
          echo "${{ env.CURRENT_STATUS }}" > status.txt

      # üîπ 8. Commit perubahan status
      - name: Commit status changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add status.txt
          git diff --staged --quiet || git commit -m "Update status: $(cat status.txt) [$(date +'%Y-%m-%d %H:%M')]"
          git push
