name: Mentari Monitor

on:
  schedule:
    - cron: '*/3 * * * *'   # tiap 3 menit
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      # ðŸ”¹ 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # ðŸ”¹ 2. REAL-TIME CHECK 
      - name: Check Mentari UNPAM
        id: check
        run: |
          URL="https://mentari.unpam.ac.id/"
          
          # Baca status sebelumnya
          if [ -f "status.txt" ]; then
            PREV_STATUS=$(cat status.txt)
          else
            PREV_STATUS="UNKNOWN"
          fi

          echo "Previous Status: $PREV_STATUS"

          # REAL-TIME CHECK dengan timeout 30 detik
          echo "ðŸ” Checking website..."
          START_TIME=$(date +%s)
          
          RESPONSE=$(timeout 30s curl -s -o /dev/null -w "%{http_code} %{time_total}" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            --connect-timeout 25 \
            --max-time 30 \
            "$URL" 2>&1)
          
          CURL_EXIT=$?
          END_TIME=$(date +%s)
          TOTAL_TIME=$((END_TIME - START_TIME))
          
          STATUS_CODE=$(echo "$RESPONSE" | awk '{print $1}')
          RESPONSE_TIME=$(echo "$RESPONSE" | awk '{print $2}')
          
          if [ -z "$RESPONSE_TIME" ]; then
            RESPONSE_TIME=$TOTAL_TIME
          fi

          # Tentukan status
          if [ "$STATUS_CODE" = "200" ]; then
            if (( $(echo "$RESPONSE_TIME > 15" | bc -l 2>/dev/null || echo "0") )); then
              CURRENT_STATUS="VERY_SLOW"
            elif (( $(echo "$RESPONSE_TIME > 8" | bc -l 2>/dev/null || echo "0") )); then
              CURRENT_STATUS="SLOW" 
            else
              CURRENT_STATUS="UP"
            fi
          elif [ $CURL_EXIT -eq 124 ] || [ $CURL_EXIT -eq 28 ]; then
            CURRENT_STATUS="EXTREME_SLOW"
          else
            # Quick verification
            if timeout 10s curl -s --head "$URL" >/dev/null 2>&1; then
              CURRENT_STATUS="UP"
            else
              CURRENT_STATUS="DOWN"
            fi
          fi

          echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
          echo "CURRENT_STATUS=$CURRENT_STATUS" >> $GITHUB_ENV
          echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$RESPONSE_TIME" >> $GITHUB_ENV

          echo "ðŸ“Š Result: $PREV_STATUS â†’ $CURRENT_STATUS (${RESPONSE_TIME}s)"

      # ðŸ”¹ 3. Notif UP - ESTHETIC âœ…
      - name: Send Discord UP
        if: env.CURRENT_STATUS == 'UP' && env.PREV_STATUS != 'UP'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"âœ… MENTARI UNPAM ONLINE\",
              \"description\": \"Website dapat diakses dengan **respon normal**.\",
              \"color\": 5763719,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/845/845646.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"ðŸ“Š Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"âš¡ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"ðŸŸ¢ Status\", \"value\": \"**OPERATIONAL**\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"ðŸŒ Monitor\", \"value\": \"GitHub Actions\", \"inline\": true}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "UP" > status.txt
          echo "âœ… UP notification sent"

      # ðŸ”¹ 4. Notif SLOW - ðŸŸ¡
      - name: Send Discord SLOW
        if: (env.CURRENT_STATUS == 'SLOW' || env.CURRENT_STATUS == 'VERY_SLOW') && env.PREV_STATUS != 'SLOW' && env.PREV_STATUS != 'VERY_SLOW'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          if [ "${{ env.CURRENT_STATUS }}" = "VERY_SLOW" ]; then
            TITLE="ðŸŒ MENTARI UNPAM - SANGAT LAMBAT"
            COLOR=16753920
            STATUS_TEXT="**HIGH LATENCY**"
            DESC="Website dapat diakses namun **sangat lambat** (>15s)"
            EMOJI="ðŸŒ"
          else
            TITLE="ðŸŸ¡ MENTARI UNPAM - LAMBAT"
            COLOR=16776960
            STATUS_TEXT="**SLOW**"
            DESC="Website dapat diakses namun **lambat** (>8s)"
            EMOJI="ðŸŸ¡"
          fi
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"${TITLE}\",
              \"description\": \"${DESC}\",
              \"color\": ${COLOR},
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/4206/4206274.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"ðŸ“Š Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"â±ï¸ Response Time\", \"value\": \"\`${{ env.RESPONSE_TIME }}s\`\", \"inline\": true},
                {\"name\": \"${EMOJI} Status\", \"value\": \"${STATUS_TEXT}\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"ðŸ’¡ Info\", \"value\": \"Server mungkin sedang sibuk\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "SLOW" > status.txt
          echo "ðŸŸ¡ SLOW notification sent"

      # ðŸ”¹ 5. Notif EXTREME SLOW - ðŸš¨
      - name: Send Discord EXTREME SLOW
        if: env.CURRENT_STATUS == 'EXTREME_SLOW' && env.PREV_STATUS != 'EXTREME_SLOW'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"ðŸš¨ MENTARI UNPAM - EXTREME SLOW\",
              \"description\": \"Website **timeout** (>30s) namun mungkin masih bisa diakses dengan sangat lambat.\",
              \"color\": 15105570,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"â° Response Time\", \"value\": \"\`>30s (Timeout)\`\", \"inline\": true},
                {\"name\": \"ðŸš¨ Status\", \"value\": \"**EXTREME LATENCY**\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"âš ï¸ Note\", \"value\": \"Website mungkin masih UP tapi sangat lambat\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "EXTREME_SLOW" > status.txt
          echo "ðŸš¨ EXTREME SLOW notification sent"

      # ðŸ”¹ 6. Notif DOWN - ðŸ”´
      - name: Send Discord DOWN
        if: env.CURRENT_STATUS == 'DOWN' && env.PREV_STATUS != 'DOWN'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          curl -X POST -H "Content-Type: application/json" -d "{
            \"username\": \"ðŸŒ Mentari Monitor\",
            \"embeds\": [{
              \"title\": \"ðŸ”´ MENTARI UNPAM - OFFLINE\",
              \"description\": \"Website **tidak dapat diakses** setelah verifikasi ganda.\",
              \"color\": 15548997,
              \"thumbnail\": {\"url\": \"https://cdn-icons-png.flaticon.com/512/753/753345.png\"},
              \"fields\": [
                {\"name\": \"ðŸ”— URL\", \"value\": \"[mentari.unpam.ac.id](https://mentari.unpam.ac.id)\", \"inline\": true},
                {\"name\": \"ðŸ“Š Status Code\", \"value\": \"\`${{ env.STATUS_CODE }}\`\", \"inline\": true},
                {\"name\": \"ðŸ”´ Status\", \"value\": \"**OFFLINE**\", \"inline\": true},
                {\"name\": \"ðŸ”„ Previous\", \"value\": \"\`${{ env.PREV_STATUS }}\`\", \"inline\": true},
                {\"name\": \"âœ… Verified\", \"value\": \"Double-checked\", \"inline\": true},
                {\"name\": \"ðŸŒ Monitor\", \"value\": \"GitHub Actions\", \"inline\": true}
              ],
              \"footer\": {\"text\": \"Mentari Monitor â€¢ $(date +'%H:%M:%S')\", \"icon_url\": \"https://github.com/favicon.ico\"},
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"

          echo "DOWN" > status.txt
          echo "ðŸ”´ DOWN notification sent"

      # ðŸ”¹ 7. Status unchanged
      - name: Status unchanged
        if: env.CURRENT_STATUS == env.PREV_STATUS
        run: |
          echo "âœ… Status unchanged: ${{ env.CURRENT_STATUS }}"
          echo "${{ env.CURRENT_STATUS }}" > status.txt

      # ðŸ”¹ 8. Commit status
      - name: Commit status changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add status.txt
          git diff --staged --quiet || git commit -m "Status: $(cat status.txt) [$(date +'%H:%M')]"
          git push
