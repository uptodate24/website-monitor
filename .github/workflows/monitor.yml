name: Website Health Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # setiap 5 menit
  workflow_dispatch:        # bisa dijalankan manual

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Restore status sebelumnya dari cache
    - name: Restore previous status
      id: restore
      uses: actions/cache@v3
      with:
        path: status.txt
        key: website-status

    # 2Ô∏è‚É£ Cek status website
    - name: Check Mentari UNPAM
      id: check
      run: |
        STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://mentari.unpam.ac.id/" --connect-timeout 10 --max-time 10)
        echo "Status Code: $STATUS_CODE"

        PREV_STATUS=$(cat status.txt 2>/dev/null || echo "UNKNOWN")
        echo "Previous Status: $PREV_STATUS"

        echo "STATUS_CODE=$STATUS_CODE" >> $GITHUB_ENV
        echo "PREV_STATUS=$PREV_STATUS" >> $GITHUB_ENV

    # 3Ô∏è‚É£ Kirim notifikasi Discord kalau berubah
    - name: Send Discord Notification if status changed
      if: env.STATUS_CODE != ''  # pastikan ada status
      run: |
        if [ "$STATUS_CODE" -eq 200 ] && [ "$PREV_STATUS" != "UP" ]; then
          echo "üü¢ Website BACK UP - Sending notification..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"üü¢ **MENTARI UNPAM BACK UP**\\nURL: https://mentari.unpam.ac.id/\\nStatus: $STATUS_CODE\\nTime: $(date -u)\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
          echo "UP" > status.txt

        elif [ "$STATUS_CODE" -ne 200 ] && [ "$PREV_STATUS" != "DOWN" ]; then
          echo "üî¥ Website DOWN - Sending notification..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"üî¥ **MENTARI UNPAM DOWN**\\nURL: https://mentari.unpam.ac.id/\\nStatus: $STATUS_CODE\\nTime: $(date -u)\"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
          echo "DOWN" > status.txt
        else
          echo "‚úÖ Status unchanged - No notification needed"

    # 4Ô∏è‚É£ Simpan status.txt ke cache supaya bisa dibaca di run berikutnya
    - name: Save status to cache
      uses: actions/cache@v3
      with:
        path: status.txt
        key: website-status
